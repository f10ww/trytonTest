name: Tryton DevSecOps Security Pipeline

on:
  push:
    branches: ["main"]
  pull_request:

permissions:
  contents: read
  security-events: write
  issues: write

jobs:
  security:
    runs-on: ubuntu-latest

    steps:
      # -------------------------------------------------
      # Check out repository
      # -------------------------------------------------
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      # -------------------------------------------------
      # Python Setup for Tryton
      # -------------------------------------------------
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          # Try requirements; ignore if missing
          pip install -r requirements.txt || true
          pip install bandit semgrep

      # -------------------------------------------------
      # Bandit (diff only)
      # -------------------------------------------------
      - name: Run Bandit only on changed Python files
        id: bandit
        shell: bash
        run: |
          echo "Detecting changed Python files..."

          if [ "${{ github.event_name }}" = "pull_request" ]; then
            RANGE="${{ github.event.pull_request.base.sha }}...${{ github.event.pull_request.head.sha }}"
          else
            if [ "${{ github.event.before }}" = "0000000000000000000000000000000000000000" ]; then
              RANGE="HEAD~1"
            else
              RANGE="${{ github.event.before }}...${{ github.event.after }}"
            fi
          fi

          echo "Using diff range: $RANGE"
          mapfile -t FILES < <(git diff --name-only "$RANGE" | grep -E '\.py$' || true)

          if [ "${#FILES[@]}" -eq 0 ]; then
            echo "No Python files changed."
            echo "{}" > bandit-report.json
            exit 0
          fi

          echo "Changed Python files:"
          printf '%s\n' "${FILES[@]}"

          bandit -f json -o bandit-report.json "${FILES[@]}" || true

      # -------------------------------------------------
      # Semgrep SAST (auto diff mode)
      # -------------------------------------------------
      - name: Run Semgrep SAST
        uses: returntocorp/semgrep-action@v1
        with:
          config: "p/ci"
          publishToken: ${{ secrets.SEMGREP_TOKEN }}
          auditOn: push

      # -------------------------------------------------
      # OWASP Dependency-Check
      # -------------------------------------------------
      - name: OWASP Dependency Check
        uses: dependency-check/Dependency-Check_Action@main
        with:
          project: "tryton"
          path: "."
          format: "JSON"
          out: "dependency-check-report"

      - name: Upload Dependency Check Report
        uses: actions/upload-artifact@v4
        with:
          name: dependency-check-report
          path: dependency-check-report

      # -------------------------------------------------
      # Trivy
      # -------------------------------------------------
      - name: Trivy FS Scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: "fs"
          severity: "CRITICAL,HIGH"
          format: "json"
          output: "trivy-report.json"

      # -------------------------------------------------
      # FIXED: Snyk now works with Tryton
      # -------------------------------------------------
      - name: Install Snyk CLI
        uses: snyk/actions/setup@master

      - name: Run Snyk Dependency Scan
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: |
          # Prefer requirements.txt, fallback to setup.py or pyproject.toml
          if [ -f "requirements.txt" ]; then
            TARGET_FILE="requirements.txt"
          elif [ -f "setup.py" ]; then
            TARGET_FILE="setup.py"
          elif [ -f "pyproject.toml" ]; then
            TARGET_FILE="pyproject.toml"
          else
            echo "No dependency file found; creating empty report."
            echo "{}" > snyk-report.json
            exit 0
          fi

          echo "Running Snyk scan using: $TARGET_FILE"

          snyk test \
            --file="$TARGET_FILE" \
            --package-manager=pip \
            --skip-unresolved \
            --json-file-output=snyk-report.json || true

      # -------------------------------------------------
      # Upload all outputs
      # -------------------------------------------------
      - name: Upload Security Reports
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: |
            bandit-report.json
            trivy-report.json
            snyk-report.json

      # -------------------------------------------------
      # Auto-create issue on failure
      # -------------------------------------------------
      - name: Create GitHub Issue on Vulnerabilities
        if: failure()
        uses: dacbd/create-issue-action@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          title: "⚠️ Security Vulnerability Detected in Pipeline"
          body: |
            One or more security scanners detected vulnerabilities.

            Reports included:
            - Bandit (diff only)
            - Semgrep
            - Trivy
            - Snyk
            - OWASP Dependency-Check

            Please review the uploaded reports.
