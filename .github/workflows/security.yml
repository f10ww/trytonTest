name: Tryton DevSecOps Security Pipeline

on:
  push:
    branches: ["main"]
  pull_request:

permissions:
  contents: read
  security-events: write
  issues: write

jobs:
  security:
    runs-on: ubuntu-latest

    steps:
      # -------------------------------------------------
      # Checkout code
      # -------------------------------------------------
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      # -------------------------------------------------
      # Python Setup for Tryton
      # -------------------------------------------------
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install -r requirements.txt || true
          pip install bandit semgrep

      # -------------------------------------------------
      # Bandit (diff-only)
      # -------------------------------------------------
      - name: Run Bandit on changed Python files
        id: bandit
        shell: bash
        run: |
          echo "Detecting changed Python files..."

          if [ "${{ github.event_name }}" = "pull_request" ]; then
            RANGE="${{ github.event.pull_request.base.sha }}...${{ github.event.pull_request.head.sha }}"
          else
            if [ "${{ github.event.before }}" = "0000000000000000000000000000000000000000" ]; then
              RANGE="HEAD~1"
            else
              RANGE="${{ github.event.before }}...${{ github.event.after }}"
            fi
          fi

          echo "Using range: $RANGE"
          mapfile -t FILES < <(git diff --name-only "$RANGE" | grep -E '\.py$' || true)

          if [ "${#FILES[@]}" -eq 0 ]; then
            echo "No Python files changed."
            echo "{}" > bandit-report.json
            exit 0
          fi

          printf '%s\n' "${FILES[@]}"
          bandit -f json -o bandit-report.json "${FILES[@]}" || true

      - name: Upload Bandit Report
        uses: actions/upload-artifact@v4
        with:
          name: bandit-report
          path: bandit-report.json

      # -------------------------------------------------
      # Semgrep SAST
      # -------------------------------------------------
      - name: Run Semgrep SAST
        uses: returntocorp/semgrep-action@v1
        with:
          config: "p/ci"
          publishToken: ${{ secrets.SEMGREP_TOKEN }}
          auditOn: push

      # -------------------------------------------------
      # OWASP Dependency Check
      # -------------------------------------------------
      - name: OWASP Dependency Check
        uses: dependency-check/Dependency-Check_Action@main
        with:
          project: "tryton"
          path: "."
          format: "JSON"
          out: "dependency-check-report"

      - name: Upload Dependency Check Report
        uses: actions/upload-artifact@v4
        with:
          name: dependency-check-report
          path: dependency-check-report

      # -------------------------------------------------
      # Trivy FS Scan
      # -------------------------------------------------
      - name: Trivy FS Scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: "fs"
          severity: "CRITICAL,HIGH"
          format: "json"
          output: "trivy-report.json"

      - name: Upload Trivy Report
        uses: actions/upload-artifact@v4
        with:
          name: trivy-report
          path: trivy-report.json

      # -------------------------------------------------
      # Snyk
      # -------------------------------------------------
      - name: Install Snyk CLI
        uses: snyk/actions/setup@master

      - name: Run Snyk Dependency Scan
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: |
          if [ -f "requirements.txt" ]; then
            TARGET_FILE="requirements.txt"
          elif [ -f "setup.py" ]; then
            TARGET_FILE="setup.py"
          elif [ -f "pyproject.toml" ]; then
            TARGET_FILE="pyproject.toml"
          else
            echo "{}" > snyk-report.json
            exit 0
          fi

          echo "Running Snyk using: $TARGET_FILE"

          snyk test \
            --file="$TARGET_FILE" \
            --package-manager=pip \
            --skip-unresolved \
            --json-file-output=snyk-report.json || true

      - name: Upload Snyk Report
        uses: actions/upload-artifact@v4
        with:
          name: snyk-report
          path: snyk-report.json

      # -------------------------------------------------
      # Evaluate all reports for vulnerabilities
      # -------------------------------------------------
      - name: Evaluate Security Reports
        id: vuln_check
        run: |
          echo "Evaluating reports..."
          HAS_VULNS=0

          # Bandit
          if grep -q '"issue_severity":' bandit-report.json 2>/dev/null; then
            echo "Bandit found issues."
            HAS_VULNS=1
          fi

          # Trivy
          if grep -q '"Severity":' trivy-report.json 2>/dev/null; then
            echo "Trivy found issues."
            HAS_VULNS=1
          fi

          # Snyk
          if grep -q '"severity":' snyk-report.json 2>/dev/null; then
            echo "Snyk found issues."
            HAS_VULNS=1
          fi

          # Dependency-Check
          if grep -q '"severity"' dependency-check-report/dependency-check-report.json 2>/dev/null; then
            echo "Dependency-Check found issues."
            HAS_VULNS=1
          fi

          echo "HAS_VULNS=$HAS_VULNS" >> $GITHUB_ENV

      # -------------------------------------------------
      # Create issue when ANY tool reports vulnerabilities
      # -------------------------------------------------
      - name: Create GitHub Issue on Vulnerabilities
        if: env.HAS_VULNS == '1'
        uses: dacbd/create-issue-action@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          title: "⚠️ Security Vulnerabilities Detected in Pipeline"
          body: |
            One or more security scanners detected vulnerabilities.

            Reports generated:
            - Bandit
            - Semgrep
            - Trivy
            - Snyk
            - OWASP Dependency-Check

            Download the workflow artifacts to review full details.

      # -------------------------------------------------
      # Optional: Fail the job if vulnerabilities exist
      # -------------------------------------------------
      - name: Fail job if vulnerabilities detected
        if: env.HAS_VULNS == '1'
        run: exit 1
