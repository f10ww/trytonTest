name: Tryton DevSecOps Security Pipeline

on:
  push:
    branches: ["main"]
  pull_request:

permissions:
  contents: read
  security-events: write
  issues: write

jobs:
  security:
    runs-on: ubuntu-latest

    steps:
      # -------------------------------------------------
      # Check out repository
      # -------------------------------------------------
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # REQUIRED for diff-based scanning

      # -------------------------------------------------
      # Python Setup for Tryton
      # -------------------------------------------------
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install -r requirements.txt || true
          pip install bandit semgrep

      # -------------------------------------------------
      # 1. Static Code Analysis - Bandit (DIFF MODE, FIXED)
      # -------------------------------------------------
      - name: Run Bandit only on changed Python files
        id: bandit
        shell: bash
        run: |
          echo "Detecting changed Python files..."

          # Determine correct diff range
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            RANGE="${{ github.event.pull_request.base.sha }}...${{ github.event.pull_request.head.sha }}"
          else
            # If before/after are null (e.g. first commit), use HEAD~1
            if [ "${{ github.event.before }}" = "0000000000000000000000000000000000000000" ]; then
              RANGE="HEAD~1"
            else
              RANGE="${{ github.event.before }}...${{ github.event.after }}"
            fi
          fi

          echo "Using diff range: $RANGE"

          # Gather changed python files
          mapfile -t FILES < <(git diff --name-only "$RANGE" | grep -E '\.py$' || true)

          if [ "${#FILES[@]}" -eq 0 ]; then
            echo "No Python files changed."
            echo "{}" > bandit-report.json
            exit 0
          fi

          echo "Changed Python files:"
          printf '%s\n' "${FILES[@]}"

          # Run Bandit on only changed files
          bandit -f json -o bandit-report.json "${FILES[@]}" || true

      # -------------------------------------------------
      # 1. Static Code Analysis - Semgrep (AUTO DIFF MODE)
      # -------------------------------------------------
      - name: Run Semgrep SAST
        uses: returntocorp/semgrep-action@v1
        with:
          config: "p/ci"
          publishToken: ${{ secrets.SEMGREP_TOKEN }}
          auditOn: push

      # -------------------------------------------------
      # 2. Dependency & Open Source Security Scanning
      # -------------------------------------------------

      # OWASP Dependency-Check
      - name: OWASP Dependency Check
        uses: dependency-check/Dependency-Check_Action@main
        with:
          project: "tryton"
          path: "."
          format: "JSON"
          out: "dependency-check-report"

      - name: Upload Dependency Check Report
        uses: actions/upload-artifact@v4
        with:
          name: dependency-check-report
          path: dependency-check-report

      # Trivy Vulnerability Scan
      - name: Trivy FS Scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: "fs"
          severity: "CRITICAL,HIGH"
          format: "json"
          output: "trivy-report.json"

      # Snyk Dependency Scan
      - name: Snyk Dependency Scan
        uses: snyk/actions/python-3.11@master
        with:
          args: --json-file-output=snyk-report.json
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

      # -------------------------------------------------
      # 3. Upload Reports as Artifacts
      # -------------------------------------------------
      - name: Upload Security Reports
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: |
            bandit-report.json
            trivy-report.json
            snyk-report.json

      # -------------------------------------------------
      # 4. Automated Developer Notifications
      # -------------------------------------------------
      - name: Create GitHub Issue on Vulnerabilities
        if: failure()
        uses: dacbd/create-issue-action@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          title: "⚠️ Security Vulnerability Detected in Pipeline"
          body: |
            One or more security scanners detected vulnerabilities.

            Reports included:
            - Bandit (diff-only)
            - Semgrep (diff-only)
            - Trivy
            - Snyk
            - OWASP Dependency-Check

            Please review the uploaded reports.
